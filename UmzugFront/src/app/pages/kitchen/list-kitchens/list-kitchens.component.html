<app-breadcrumbs
  title="Küchenliste"
  [breadcrumbItems]="breadCrumbItems">
</app-breadcrumbs>

<div class="row">
  <div class="col-lg-12">
    <div class="card mb-4">
      <div class="card-body p-3">
        <div id="kitchenList">
          <div class="row g-2 mb-3">
            <div class="btn-group d-flex justify-content-center" role="group" aria-label="Filter options">
              <button type="button" class="btn btn-soft-secondary waves-effect mx-1"
                [class.active]="currentFilter==='all'"
                (click)="setFilter('all')">Alle</button>
              <button type="button" class="btn btn-soft-secondary waves-effect mx-1"
                [class.active]="currentFilter==='assemblage'"
                (click)="setFilter('assemblage')">Montage</button>
              <button type="button" class="btn btn-soft-secondary waves-effect mx-1"
                [class.active]="currentFilter==='dessemblage'"
                (click)="setFilter('dessemblage')">Demontage</button>
              <button type="button" class="btn btn-soft-secondary waves-effect mx-1"
                [class.active]="currentFilter==='transportKitchen'"
                (click)="setFilter('transportKitchen')">Transport Küche</button>
                                        <div class="d-flex justify-content-end">

              <button type="button" class="btn btn-success"(click)="addKitchen()">
                <i class="ri-add-line align-bottom me-1"></i> Hinzufügen
              </button>
              </div>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-bordered table-sm">
              <thead>
                <tr class="bg-light text-muted">
                  <th>ID</th>
                  <th>Montage</th>
                  <th>Demontage</th>
                  <th>Transport Küche</th>
                  <th>Küche Typ</th>
                  <th>Meter</th>
                  <th>Preis (€)</th>
                  <th>Aktionen</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let kitchen of listKitchens | slice: (currentPage - 1) * itemsPerPage : currentPage * itemsPerPage">
                  <td>{{ kitchen.id_kitchen }}</td>
                  <td>
                    <span *ngIf="kitchen.assemblage" class="badge bg-success">Ja</span>
                    <span *ngIf="!kitchen.assemblage" class="badge bg-secondary">Nein</span>
                  </td>
                  <td>
                    <span *ngIf="kitchen.dessemblage" class="badge bg-info">Ja</span>
                    <span *ngIf="!kitchen.dessemblage" class="badge bg-secondary">Nein</span>
                  </td>
                  <td>
                    <span *ngIf="kitchen.transportKitchen" class="badge bg-primary">Ja</span>
                    <span *ngIf="!kitchen.transportKitchen" class="badge bg-secondary">Nein</span>
                  </td>
                  <td>
                    <span >
                      <span *ngIf="kitchen.newKitchen" class="badge bg-success">Neu</span>
                      <span *ngIf="!kitchen.newKitchen" class="badge bg-warning">Alt</span>
                    </span>
                  </td>
                  <td>
                    <span *ngIf="kitchen.assemblage && kitchen.meters">{{ kitchen.meters }}m</span>
                    <span *ngIf="!kitchen.assemblage || !kitchen.meters" class="text-muted">-</span>
                  </td>
                  <td>{{ kitchen.price | number:'1.2-2' }}</td>
                  <td>
                    <a
                      class="text-primary me-2"
                      style="cursor: pointer;"
                      (click)="openModal(kitchen, content)">
                      <i class="ri-pencil-fill fs-16"></i>
                    </a>
                    <a
                      class="text-danger"
                      style="cursor: pointer;"
                      (click)="confirmDelete(deleteModal, kitchen.id_kitchen)">
                      <i class="ri-delete-bin-5-fill fs-16"></i>
                    </a>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="d-flex justify-content-end mt-3">
            <ngb-pagination
              [collectionSize]="length"
              [(page)]="currentPage"
              [pageSize]="itemsPerPage"
              [maxSize]="5"
              [rotate]="true"
              (pageChange)="pageChanged($event)">
            </ngb-pagination>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<ng-template #content let-modal>
  <form [formGroup]="editKitchenForm" (ngSubmit)="saveKitchen()" novalidate>
    <div class="modal-header bg-light p-3">
      <h5 class="modal-title">Küche bearbeiten (ID: {{ selectedKitchen.id_kitchen }})</h5>
      <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
    </div>
    <div class="modal-body">

      <div class="mb-3 form-check">
        <input type="checkbox" class="form-check-input" formControlName="assemblage" id="assemblageCheck" />
        <label for="assemblageCheck" class="form-check-label">Montage</label>
      </div>

      <div class="mb-3 form-check">
        <input type="checkbox" class="form-check-input" formControlName="dessemblage" id="dessemblageCheck" />
        <label for="dessemblageCheck" class="form-check-label">Demontage</label>
      </div>

      <div class="mb-3 form-check">
        <input type="checkbox" class="form-check-input" formControlName="transportKitchen" id="transportKitchenCheck" />
        <label for="transportKitchenCheck" class="form-check-label">Transport Küche</label>
      </div>

      <!-- New Kitchen (show when Montage OR Transport is checked) -->
      <div class="mb-3 form-check" *ngIf="f['assemblage'].value || f['transportKitchen'].value">
        <input type="checkbox" class="form-check-input" formControlName="newKitchen" id="newKitchenCheck" />
        <label for="newKitchenCheck" class="form-check-label">Neue Küche</label>
        <small class="form-text text-muted d-block" *ngIf="f['assemblage'].value && !f['transportKitchen'].value">
          {{ f['newKitchen'].value ? 'Montage: 180€ pro Meter' : 'Montage: 110€ pro Meter' }}
        </small>
        <small class="form-text text-muted d-block" *ngIf="!f['assemblage'].value && f['transportKitchen'].value">
          {{ f['newKitchen'].value ? 'Transport: 250€' : 'Transport: 150€' }}
        </small>
        <small class="form-text text-muted d-block" *ngIf="f['assemblage'].value && f['transportKitchen'].value">
          {{ f['newKitchen'].value ? 'Montage: 180€/m + Transport: 250€' : 'Montage: 110€/m + Transport: 150€' }}
        </small>
      </div>

      <!-- Meters (only show when Montage is checked) -->
      <div class="mb-3" *ngIf="f['assemblage'].value">
        <label for="metersInput" class="form-label">Meter (Mindestens 5m)</label>
        <input
          type="number"
          id="metersInput"
          class="form-control"
          formControlName="meters"
          step="0.5"
          min="5"
          placeholder="z.B. 5.5" />
        <small class="form-text text-muted">Mindestens 5 Meter erforderlich</small>
      </div>

      <div class="mb-3">
        <label for="priceInput" class="form-label">Preis (€)</label>
        <input
          type="number"
          id="priceInput"
          class="form-control"
          formControlName="price"
          step="0.01"
          min="0"
          placeholder="z.B. 123.45"
          [readonly]="(f['assemblage'].value || f['transportKitchen'].value || f['dessemblage'].value) && 
                     !(f['assemblage'].value && f['dessemblage'].value && f['transportKitchen'].value)" />
        <small class="form-text text-muted" *ngIf="f['assemblage'].value || f['transportKitchen'].value || f['dessemblage'].value">
          Preis wird automatisch berechnet
        </small>
        <div *ngIf="submitted && f['price'].invalid" class="text-danger small mt-1">
          <div *ngIf="f['price'].errors?.['required']">Preis ist erforderlich.</div>
          <div *ngIf="f['price'].errors?.['pattern']">Bitte geben Sie einen gültigen Preis ein (z.B. 123.45).</div>
        </div>
      </div>

    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="modal.dismiss()">Abbrechen</button>
      <button type="submit" class="btn btn-primary">Speichern</button>
    </div>
  </form>
</ng-template>

<!-- Delete Confirmation Modal -->
<ng-template #deleteModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Bestätigung</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <p>Möchten Sie diese Küche wirklich löschen?</p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.dismiss()">Abbrechen</button>
    <button type="button" class="btn btn-danger" (click)="deleteKitchen(selectedKitchen.id_kitchen)">Löschen</button>
  </div>
</ng-template>