<!-- list-umzugs.component.html -->
<app-breadcrumbs
    title="Umzug Liste"
    [breadcrumbItems]="breadCrumbItems">
</app-breadcrumbs>

<div class="row">
    <div class="col-lg-12">
        <div class="card mb-4">
            <div class="card-body p-3">
                <div id="umzugList">
                    <!-- Header Actions -->
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <h5 class="card-title mb-0">
                                <i class="ri-truck-line me-2"></i>
                                Umzug Anfragen ({{ length }})
                            </h5>
                        </div>
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-success" (click)="addUmzug()">
                                    <i class="ri-add-line align-bottom me-1"></i> Hinzufügen
                                </button>
                        </div>
                    </div>

                    <!-- Loading Spinner -->
                    <div *ngIf="loading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="table-responsive" *ngIf="!loading">
                        <table class="table table-bordered table-sm">
                            <thead>
                                <tr class="bg-light text-muted">
                                    <th>ID</th>
                                    <th>Kunde</th>
                                    <th>Route</th>
                                    <th>Volumen (m³)</th>
                                    <th>Gesamtpreis</th>
                                    <th>Status</th>
                                    <th>Erstellt</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let umzug of listUmzugs">
                                    <td>
                                        <span class="fw-bold">#{{ umzug.id_request }}</span>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>{{ umzug.clientName }}</strong>
                                            <br>
                                            <small class="text-muted">{{ umzug.clientEmail }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="ri-map-pin-line text-success me-1"></i>
                                            <small>{{ umzug.departPoint }}</small>
                                        </div>
                                        <div class="d-flex align-items-center mt-1">
                                            <i class="ri-map-pin-fill text-danger me-1"></i>
                                            <small>{{ umzug.arrivalPoint }}</small>
                                        </div>
                                        <small class="badge bg-secondary">{{ umzug.distanceKm }} km</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">
                                            {{ umzug.totalVolumeM3 | number:'1.2-2' }} m³
                                        </span>
                                    </td>
                                    <td>
                                        <strong>{{ umzug.totalPrice | number:'1.2-2' }}€</strong>
                                    </td>
                                    <td>
                                        <span class="badge" [ngClass]="getStatusBadge(umzug)">
                                            <span *ngIf="umzug.totalPrice > 1000">Groß</span>
                                            <span *ngIf="umzug.totalPrice > 500 && umzug.totalPrice <= 1000">Mittel</span>
                                            <span *ngIf="umzug.totalPrice <= 500">Klein</span>
                                        </span>
                                    </td>
                                    <td>
                                        <small>{{ formatDate(umzug.date) }}</small>
                                    </td>
                                    <td>
                                        <div class="d-flex gap-2">
                                            <button
                                                class="btn btn-sm btn-outline-primary"
                                                (click)="viewDetails(umzug, detailModal)"
                                                title="Details anzeigen">
                                                <i class="ri-eye-line"></i>
                                            </button>
                                            <button
                                                class="btn btn-sm btn-outline-warning"
                                                (click)="editUmzug(umzug)"
                                                title="Bearbeiten">
                                                <i class="ri-pencil-line"></i>
                                            </button>
                                            <button
                                                class="btn btn-sm btn-outline-danger"
                                                (click)="deleteUmzug(umzug)"
                                                title="Löschen">
                                                <i class="ri-delete-bin-line"></i>
                                            </button>
                                            <button
                                                class="btn btn-sm btn-outline-primary"
                                                (click)="openAssignUserModal(umzug, assignUserModal)"
                                                title="Benutzer zuweisen">
                                                <i class="ri-user-add-line"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <!-- Empty state -->
                        <div *ngIf="listUmzugs.length === 0" class="text-center py-4">
                            <i class="ri-truck-line display-4 text-muted"></i>
                            <h5 class="mt-3">Keine Umzug Anfragen gefunden</h5>
                            <p class="text-muted">Erstellen Sie eine neue Anfrage um zu beginnen.</p>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div class="d-flex justify-content-end mt-3" *ngIf="length > itemsPerPage">
                        <ngb-pagination
                            [collectionSize]="length"
                            [(page)]="currentPage"
                            [pageSize]="itemsPerPage"
                            [maxSize]="5"
                            [rotate]="true"
                            (pageChange)="pageChanged($event)">
                        </ngb-pagination>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detail Modal -->
<ng-template #detailModal let-modal>
    <div class="modal-header bg-primary text-white">
        <h4 class="modal-title">
            <i class="ri-truck-line me-2"></i>
            Umzug Details - {{ selectedUmzug?.clientName }}
        </h4>
        <button type="button" class="btn-close btn-close-white" (click)="closeModal()"></button>
    </div>
    
    <div class="modal-body" *ngIf="selectedUmzug">
        <!-- Loading state -->
        <div *ngIf="loading" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- Content -->
        <div *ngIf="!loading">
            <!-- Customer Info -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card border-left-primary">
                        <div class="card-body">
                            <h6 class="card-title text-primary">
                                <i class="ri-user-line me-1"></i> Kundeninformationen
                            </h6>
                            <p class="mb-1"><strong>Name:</strong> {{ selectedUmzug.clientName }}</p>
                            <p class="mb-1"><strong>Email:</strong> {{ selectedUmzug.clientEmail }}</p>
                                                        <p class="mb-1"><strong>Nummer:</strong> {{ selectedUmzug.phone }}</p>

                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-left-success">
                        <div class="card-body">
                            <h6 class="card-title text-success">
                                <i class="ri-map-line me-1"></i> Route Details
                            </h6>
                            <p class="mb-1"><strong>Von:</strong> {{ selectedUmzug.departPoint }}</p>
                            <p class="mb-1"><strong>Nach:</strong> {{ selectedUmzug.arrivalPoint }}</p>
                            <p class="mb-0"><strong>Entfernung:</strong> {{ selectedUmzug.distanceKm }} km</p>
                            <p class="mb-0"><strong>UmzugDatum:</strong> {{ selectedUmzug.umzugdate }} </p>

                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Details -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="ri-settings-line me-1"></i> Service Details
                            </h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <p class="mb-1"><strong>Etagen Abfahrtsort:</strong> {{ selectedUmzug.numberOfEtagesDepart }}</p>
                                    <p class="mb-1">
                                        <strong>Aufzug Abfahrtsort:</strong> 
                                        <span class="badge" [ngClass]="selectedUmzug.withElevatorDepart ? 'bg-success' : 'bg-danger'">
                                            {{ selectedUmzug.withElevatorDepart ? 'Ja' : 'Nein' }}
                                        </span>
                                    </p>
                                </div>
                                <div class="col-md-3">
                                    <p class="mb-1"><strong>Etagen Ankunftsort:</strong> {{ selectedUmzug.numberOfEtagesArrival }}</p>
                                    <p class="mb-1">
                                        <strong>Aufzug Ankunftsort:</strong> 
                                        <span class="badge" [ngClass]="selectedUmzug.withElevatorArrival ? 'bg-success' : 'bg-danger'">
                                            {{ selectedUmzug.numberOfEtagesArrival ? 'Ja' : 'Nein' }}
                                        </span>
                                    </p>
                                </div>
                                 <div class="col-md-3">
                                    <p class="mb-1">
                                        <strong>Park Platz Abfahrtsort:</strong> 
                                        <span class="badge" [ngClass]="selectedUmzug.withParkPlatzDepart ? 'bg-success' : 'bg-danger'">
                                            {{ selectedUmzug.withParkPlatzDepart ? 'Ja' : 'Nein' }}
                                        </span>
                                    </p>
                                     <p class="mb-1">
                                        <strong>Park Platz Ankunftsort:</strong> 
                                        <span class="badge" [ngClass]="selectedUmzug.withParkPlatzArrival ? 'bg-success' : 'bg-danger'">
                                            {{ selectedUmzug.withParkPlatzArrival ? 'Ja' : 'Nein' }}
                                        </span>
                                    </p>
                                </div>
                                <div class="col-md-3">
                                    <p class="mb-1">
                                        <strong>Montage:</strong> 
                                        <span class="badge" [ngClass]="selectedUmzug.withMontage ? 'bg-success' : 'bg-danger'">
                                            {{ selectedUmzug.withMontage ? 'Ja' : 'Nein' }}
                                        </span>
                                    </p>
                                    <p class="mb-1">
                                        <strong>Demontage:</strong> 
                                        <span class="badge" [ngClass]="selectedUmzug.withDemontage ? 'bg-success' : 'bg-danger'">
                                            {{ selectedUmzug.withDemontage ? 'Ja' : 'Nein' }}
                                        </span>
                                    </p>
                                </div>
                                 <div class="col-md-3">
                                    <p class="mb-1">
                                        <strong>Montage Lamp:</strong> 
                                        <span class="badge" [ngClass]="selectedUmzug.withMontageLamp ? 'bg-success' : 'bg-danger'">
                                            {{ selectedUmzug.withMontageLamp ? 'Ja' : 'Nein' }}
                                        </span>
                                    </p>
                                      <p class="mb-1">
                                        <strong>Demontage Lamp:</strong> 
                                        <span class="badge" [ngClass]="selectedUmzug.withMontageLamp ? 'bg-success' : 'bg-danger'">
                                            {{ selectedUmzug.withMontageLamp ? 'Ja' : 'Nein' }}
                                        </span>
                                    </p>
                                </div>
                                
                                
                                <div class="col-md-6" *ngIf="selectedUmzug.kitchen">
                    <!-- Kitchen Type Display -->
                    <p class="mb-1">
                        <strong>Küchen Service:</strong>
                        <!-- Display kitchen type based on true values -->
                         <span *ngIf="selectedUmzug.kitchen.assemblage">• Montage </span>
              <span *ngIf="selectedUmzug.kitchen.dessemblage">• Demontage </span>
              <span *ngIf="selectedUmzug.kitchen.transportKitchen">• Transport</span>
                            <span *ngIf="selectedUmzug.kitchen.newKitchen" style="font-weight: bold;">• Neu</span>
                            <span *ngIf="!selectedUmzug.kitchen.newKitchen" style="font-weight: bold;">• Alt</span>
                        
                    </p>

                    <!-- Display kitchen price -->
                    <p class="mb-0"><strong>Preis:</strong> 
                        {{ 
                        (selectedUmzug.kitchen.price) 
                        }}€
                    </p>
                                </div>
                                <div class="col-md-3">
                                    <p class="mb-1"><strong>Kartons:</strong> {{ selectedUmzug.numberOfKartons }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rooms and Elements -->
            <div class="mb-4">
                <h6 class="text-primary">
                    <i class="ri-home-line me-1"></i> 
                    Räume und Möbel ({{ getTotalElements() }} Gegenstände)
                </h6>
                
                <div class="accordion" id="roomsAccordion">
                    <div 
                        *ngFor="let room of selectedUmzug.rooms; let roomIndex = index" 
                        class="accordion-item">
                        <h2 class="accordion-header">
                            <button 
                                class="accordion-button collapsed" 
                                type="button" 
                                [attr.data-bs-toggle]="'collapse'"
                                [attr.data-bs-target]="'#room' + roomIndex"
                                [attr.aria-expanded]="false"
                                (click)="toggleCollapse(roomIndex)">
                                <i class="ri-door-line me-2"></i>
                                {{ room.room?.name || 'Unbekannter Raum' }}
                                <span class="badge bg-primary ms-2">
                                    {{ room.elements.length || 0 }} Gegenstände
                                </span>
                            </button>
                        </h2>
                        <div 
                            [id]="'room' + roomIndex" 
            [ngClass]="{'accordion-collapse': true, 'collapse': !isCollapsed[roomIndex], 'show': isCollapsed[roomIndex]}">
                            <div class="accordion-body">
                                <div *ngIf="!room.elements || room.elements.length === 0" 
                                     class="text-muted text-center py-3">
                                    Keine Gegenstände in diesem Raum
                                </div>
                                
                                <div class="table-responsive" *ngIf="room.elements && room.elements.length > 0">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Anzahl</th>

                                                <th>Name</th>
                                                <th>Abmessungen (cm)</th>
                                                <th>Volumen (m³)</th>
                                                <th>Preis</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr *ngFor="let element of room.elements">
                                                <td>
                                                    <strong>{{ element.numberElement }}</strong>
                                                </td>
                                                <td>
                                                    <strong>{{ element.name }}</strong>
                                                </td>
                                                <td>
                                                    <div class="d-flex flex-wrap gap-1">
                                                        <span class="badge bg-primary">
                                                            W: {{ element.width | number:'1.1-1' }}
                                                        </span>
                                                        <span class="badge bg-success">
                                                            H: {{ element.height | number:'1.1-1' }}
                                                        </span>
                                                        <span class="badge bg-warning text-dark">
                                                            L: {{ element.length | number:'1.1-1' }}
                                                        </span>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="badge bg-info">
                                                        {{ element.q2 | number:'1.3-3' }} m³
                                                    </span>
                                                </td>
                                                <td>
                                                    <strong>{{ element.price | number:'1.2-2' }}€</strong>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Price Summary -->
            <div class="card bg-light">
                <div class="card-body">
                    <h6 class="card-title text-success">
                        <i class="ri-money-euro-circle-line me-1"></i> Preisübersicht
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Gesamtvolumen:</strong> {{ selectedUmzug.totalVolumeM3 | number:'1.3-3' }} m³</p>
                        </div>
                        <div class="col-md-6 text-end">
                            <h5 class="text-success mb-0">
                                <strong>Gesamtpreis: {{ selectedUmzug.totalPrice | number:'1.2-2' }}€</strong>
                            </h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-footer">
        <button type="button" class="btn btn-outline-primary" (click)="exportToPdf(selectedUmzug!)">
            <i class="ri-download-line me-1"></i> PDF Export
        </button>
        <button type="button" class="btn btn-warning" (click)="editUmzug(selectedUmzug!)">
            <i class="ri-pencil-line me-1"></i> Bearbeiten
        </button>
        <button type="button" class="btn btn-secondary" (click)="closeModal()">
            Schließen
        </button>
    </div>
</ng-template>

<ng-template #assignUserModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Benutzer zuweisen</h4>
    <button type="button" class="btn-close" (click)="closeModal()"></button>
  </div>
  <div class="modal-body">
    <div *ngFor="let user of users">
      <input 
        type="checkbox" 
        [checked]="selectedUserIds.has(user.id_user)"
        (change)="toggleUserSelection(user.id_user)">
      {{ user.nom }} {{ user.prenom }} ({{ user.role }})
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary" (click)="assignUsersToUmzug()">Zuweisen</button>
    <button type="button" class="btn btn-secondary" (click)="closeModal()">Schließen</button>
  </div>
</ng-template>